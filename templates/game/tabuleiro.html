{% load static %}
{% with modo|default:"single" as modo_atual %}
<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <title>Snake & Ladders â€” Tabuleiro</title>
    <link rel="stylesheet" href="{% static 'game/css/tabuleiro.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  </head>
  <body>
    {% if modo_atual == "multi" %}
      <!-- CSRF para o POST do movimento -->
      <form id="csrf-form" style="display:none;">{% csrf_token %}</form>
    {% endif %}

    <main class="container">
      <header class="topo">
        <h1>ðŸŽ² Snake & Ladders ðŸŽ²</h1>
        <div class="acoes">
          <a class="btn" href="{% url 'game:tela_inicial' %}">
            <i class="fas fa-home"></i> Tela Inicial
          </a>
          {% if modo_atual == "single" %}
            <a class="btn" href="{% url 'game:tela_inicial' %}">
              <i class="fas fa-home"></i> Tela Inicial
            </a>
            <a class="btn" href="{% url 'game:reiniciar_jogo' %}">
              <i class="fas fa-rotate"></i> Reiniciar Partida
            </a>
          {% else %}
            <form method="post" action="{% url 'game:multiplayer_leave' code=room.code %}" style="display:inline;">
              {% csrf_token %}
              <button class="btn" type="submit">
                <i class="fas fa-door-open"></i> Sair da sala
              </button>
            </form>
          {% endif %}
        </div>
      </header>

      <!-- GRID DE 3 COLUNAS -->
      <section class="conteudo-3col">

        <!-- COLUNA ESQUERDA -->
        {% if modo_atual == "single" %}
          <aside class="painel painel-esq">
            <div class="card">
              <h2>Log</h2>
              <div class="log-coluna">
                {% for rodada in log_rodadas %}
                  <section class="rodada">
                    <h3><strong>Rodada {{ forloop.counter }}</strong></h3>
                    <ul class="eventos">
                      {% for ev in rodada %}
                        <li>
                          {% if ev.jogador is not None %}
                            <span class="jog-label player-{{ ev.jogador|add:1 }}">Jogador {{ ev.jogador|add:1 }}</span>
                            {{ ev.texto }}
                          {% else %}
                            {{ ev.texto }}
                          {% endif %}
                        </li>
                      {% empty %}
                        <li class="muted">â€” Sem eventos nesta rodada â€”</li>
                      {% endfor %}
                    </ul>
                  </section>
                {% empty %}
                  <p class="muted">O log aparecerÃ¡ aqui.</p>
                {% endfor %}
              </div>
            </div>
          </aside>
        {% else %}
          <aside class="painel painel-esq">
            <div class="card">
              <h2>Log</h2>
              <div class="log-coluna" id="mp-log">
                <p class="muted">O log aparecerÃ¡ aqui.</p>
              </div>
            </div>
          </aside>
        {% endif %}

        <!-- COLUNA CENTRAL: TABULEIRO + SVG -->
        <div class="quadro">
          <div
              id="tabuleiro"
              class="tabuleiro {% if config.linhas == 5 %}tabuleiro-5x5{% elif config.linhas == 10 %}tabuleiro-10x10{% endif %}"
              data-linhas="{{ config.linhas }}"
              data-colunas="{{ config.colunas }}"
          >
            {% for n in celulas %}
              <div class="celula" data-casa="{{ n }}">
                <span class="numero">{{ n }}</span>
                <div class="pinos"></div>
              </div>
            {% endfor %}
          </div>
          <svg id="camada-svg" class="camada-svg" preserveAspectRatio="none"></svg>
        </div>

        <!-- COLUNA DIREITA -->
        <aside class="painel painel-dir">

          {% if modo_atual == "single" %}
            <div class="card">
              <h2>Status</h2>
              <p><strong>Tamanho:</strong> {{ config.linhas }} Ã— {{ config.colunas }} ({{ config.casa_final }} casas)</p>
              <p><strong>Jogadores:</strong> {{ config.qtd_total_jogadores }}</p>
              <p><strong>Vez do jogador:</strong> {{ partida.jogador_atual|add:1 }}</p>
              <p><strong>Ãšltimo dado:</strong> {{ partida.ultimo_dado|default:"â€”" }}</p>
              <p class="mensagem">{{ partida.mensagem }}</p>
            </div>

            <div class="card">
              <h2>Controles</h2>
              {% if partida.status != "finalizado" %}
                <form id="form-jogar" method="post" action="{% url 'game:jogar_rodada' %}">
                  {% csrf_token %}
                  <button id="btn-rolar" class="btn btn-primario" type="submit">Rolar dado</button>
                </form>
              {% else %}
                <p><strong>Fim de jogo!</strong></p>
                <a class="btn" href="{% url 'game:reiniciar_jogo' %}">Jogar novamente</a>
              {% endif %}
            </div>

            <div class="card">
              <h2>PosiÃ§Ãµes</h2>
              <ul class="lista-posicoes">
                {% for p in partida.posicoes %}
                  <li>Jogador {{ forloop.counter }}: casa {{ p }}</li>
                {% endfor %}
              </ul>
            </div>

          {% else %}
            <div class="card">
              <h2>Status</h2>
              <p><strong>Tamanho:</strong> {{ config.linhas }} Ã— {{ config.colunas }} ({{ config.casa_final }} casas)</p>
              <p><strong>Jogadores:</strong> <span id="mp-qtd-jogadores">â€”</span></p>
              <p><strong>Vez do jogador:</strong> <span id="mp-vez">Carregando...</span></p>
              <p><strong>Ãšltimo dado:</strong> <span id="mp-ultimo-dado">â€”</span></p>
              <p class="mensagem" id="mp-mensagem"></p>
            </div>

            <div class="card">
              <h2>Controles</h2>
              <button id="btn-rolar-mp" class="btn btn-primario">Rolar dado</button>
              <p id="mp-resultado"></p>
            </div>

            <div class="card">
              <h2>PosiÃ§Ãµes</h2>
              <ul class="lista-posicoes" id="mp-lista-posicoes"></ul>
            </div>
          {% endif %}

        </aside>

      </section>
    </main>

    <!-- Estes JSON sÃ£o lidos pelo tabuleiro.js -->
    <script id="js-posicoes"      type="application/json">{{ json_posicoes }}</script>
    <script id="js-cobras"        type="application/json">{{ json_cobras }}</script>
    <script id="js-escadas"       type="application/json">{{ json_escadas }}</script>
    <script id="js-ultimo-mov"    type="application/json">{{ json_ultimo_mov }}</script>
    <script id="js-status"        type="application/json">{{ json_status }}</script>
    <script id="js-jogador-atual" type="application/json">{{ json_jogador_atual }}</script>
    <script id="js-casa-final"    type="application/json">{{ json_casa_final }}</script>

    <!-- SEMPRE carregar o mesmo JS do tabuleiro, evita bugs na geraÃ§Ã£o e/ou desincronizaÃ§Ã£o -->
    <script defer src="{% static 'game/js/tabuleiro.js' %}"></script>

    {% if modo_atual == "single" %}
    <script>
      // Singleplayer: envia jogadas via fetch para evitar recarregar a pÃ¡gina
      window.addEventListener("DOMContentLoaded", function () {
        var form = document.getElementById("form-jogar");
        if (!form) return;

        var btn = document.getElementById("btn-rolar");
        var logCol = document.querySelector(".painel-esq .log-coluna");
        var painelDir = document.querySelector(".painel-dir");
        if (!painelDir) return;

        var cardsDir = painelDir.querySelectorAll(".card");
        var statusCard = cardsDir[0] || null;
        var posCard = cardsDir[cardsDir.length - 1] || null;
        var statusPs = statusCard ? statusCard.querySelectorAll("p") : [];
        var mensagemEl = statusCard ? statusCard.querySelector(".mensagem") : null;
        var listaPos = posCard ? posCard.querySelector(".lista-posicoes") : null;

        function escapeHtml(s) {
          return String(s || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        function renderLog(logRounds) {
          if (!logCol) return;
          if (!Array.isArray(logRounds) || !logRounds.length) {
            logCol.innerHTML = '<p class="muted">O log aparecerÃ¡ aqui.</p>';
            return;
          }
          var html = "";
          logRounds.forEach(function (rodada, idx) {
            html += '<section class="rodada">';
            html += '<h3><strong>Rodada ' + (idx + 1) + "</strong></h3>";
            html += '<ul class="eventos">';
            if (!rodada || !rodada.length) {
              html += '<li class="muted">â€” Sem eventos nesta rodada â€”</li>';
            } else {
              rodada.forEach(function (ev) {
                if (!ev) return;
                var texto = escapeHtml(ev.texto);
                if (ev.jogador === null || ev.jogador === undefined) {
                  html += "<li>" + texto + "</li>";
                } else {
                  var j = (ev.jogador | 0) + 1;
                  html += '<li><span class="jog-label player-' + j + '">Jogador ' + j + "</span> " + texto + "</li>";
                }
              });
            }
            html += "</ul></section>";
          });
          logCol.innerHTML = html;
          logCol.scrollTop = logCol.scrollHeight;
        }

        function renderPosicoes(posicoes) {
          if (!listaPos || !Array.isArray(posicoes)) return;
          var html = "";
          posicoes.forEach(function (p, i) {
            html += "<li>Jogador " + (i + 1) + ": casa " + p + "</li>";
          });
          listaPos.innerHTML = html;
        }

        function updateStatus(data) {
          if (!statusPs || !statusPs.length) return;

          var jogadorAtual = (data.jogador_atual || 0) | 0;
          var ultimoDado = data.ultimo_dado;

          if (statusPs[2]) {
            statusPs[2].innerHTML = "<strong>Vez do jogador:</strong> " + (jogadorAtual + 1);
          }
          if (statusPs[3]) {
            statusPs[3].innerHTML = "<strong>Ãšltimo dado:</strong> " + (ultimoDado == null ? "â€”" : ultimoDado);
          }

          // pega o Ãºltimo evento do log_rodadas
          var mensagem = "";
          if (Array.isArray(data.log_rodadas)) {
            outer: for (var i = data.log_rodadas.length - 1; i >= 0; i--) {
              var rodada = data.log_rodadas[i];
              if (!rodada) continue;
              for (var j = rodada.length - 1; j >= 0; j--) {
                var ev = rodada[j];
                if (ev && ev.texto) {
                  mensagem = ev.texto;
                  break outer;
                }
              }
            }
          }

          // fallback caso log venha vazio por algum motivo
          if (!mensagem && data.mensagem) {
            mensagem = data.mensagem;
          }

          if (mensagemEl) {
            mensagemEl.textContent = mensagem || "";
          }
        }

        var enviando = false;

        function aplicarResposta(data) {
          if (!data) return;

          var status = data.status || "andamento";
          var finalizado = status === "finalizado";
          var jogadorAtual = (data.jogador_atual || 0) | 0;
          var ult = data.ultimo_movimento || data.ultimo_mov || null;

          function aposAnimacao() {
            if (Array.isArray(data.log_rodadas)) {
              renderLog(data.log_rodadas);
            }
            if (Array.isArray(data.posicoes)) {
              renderPosicoes(data.posicoes);
            }
            updateStatus(data);

            if (btn) {
              if (finalizado) {
                btn.disabled = true;
              } else {
                // botÃ£o habilitado apenas quando for a vez do jogador humano
                btn.disabled = jogadorAtual !== 0;
              }
            }

            // Se a vez for de mÃ¡quina (Ã­ndice != 0) e nÃ£o finalizou, agenda jogada automÃ¡tica
            if (!finalizado && jogadorAtual !== 0) {
              setTimeout(function () {
                if (!enviando) {
                  form.requestSubmit();
                }
              }, 250);
            }
          }

          // anima primeiro, depois chama aposAnimacao
          if (window.Tabuleiro && typeof window.Tabuleiro.animateMove === "function" && ult) {
            window.Tabuleiro.animateMove({
              jogador: ult.jogador,
              de:      ult.de,
              para:    ult.para,
              pre_salto: ult.pre_salto
            }, aposAnimacao);
          } else if (window.Tabuleiro && typeof window.Tabuleiro.setPositions === "function" && Array.isArray(data.posicoes)) {
            window.Tabuleiro.setPositions(data.posicoes);
            aposAnimacao();
          } else {
            aposAnimacao();
          }
        }

        function onSubmit(e) {
          e.preventDefault();
          if (enviando) return;
          enviando = true;
          if (btn) btn.disabled = true;

          var fd = new FormData(form);

          fetch(form.action, {
            method: "POST",
            headers: {
              "X-Requested-With": "XMLHttpRequest"
            },
            body: fd
          })
            .then(function (resp) {
              var ct = resp.headers.get("Content-Type") || "";
              if (ct.indexOf("application/json") === -1) {
                throw new Error("Resposta inesperada do servidor (nÃ£o Ã© JSON). Verifique a view 'jogar_rodada'.");
              }
              return resp.json();
            })
            .then(function (data) {
              aplicarResposta(data);
            })
            .catch(function (err) {
              console.error(err);
              // Fallback: volta ao comportamento antigo com recarregamento completo
              form.removeEventListener("submit", onSubmit);
              form.submit();
            })
            .finally(function () {
              enviando = false;
            });
        }

        form.addEventListener("submit", onSubmit);
      });
    </script>
    {% endif %}

    {% if modo_atual == "multi" %}
    <script>
      // ---- IntegraÃ§Ã£o multiplayer ----
      const stateUrl = "{% url 'game:api_room_state' code=room.code %}";
      const moveUrl  = "{% url 'game:api_room_move'  code=room.code %}";

      const btnMover       = document.getElementById("btn-rolar-mp");
      const listaPosicoes  = document.getElementById("mp-lista-posicoes");
      const resultadoElem  = document.getElementById("mp-resultado");
      const vezElem        = document.getElementById("mp-vez");
      const qtdJogElem     = document.getElementById("mp-qtd-jogadores");
      const ultimoDadoElem = document.getElementById("mp-ultimo-dado");
      const msgElem        = document.getElementById("mp-mensagem");

      const csrfToken = document.querySelector("#csrf-form input[name=csrfmiddlewaretoken]").value;

      let finished = false;
      let pollId = null;
      let you = null;
      let meIndex = 0;
      let posicoes = []; // espelho local para animar o "de" -> "para"

      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function renderLog(logRounds) {
        const wrap = document.getElementById("mp-log");
        if (!wrap) return;

        if (!logRounds || !logRounds.length) {
          wrap.innerHTML = '<p class="muted">O log aparecerÃ¡ aqui.</p>';
          return;
        }

        let html = "";
        logRounds.forEach((rodada, idx) => {
          html += `<section class="rodada">
            <h3><strong>Rodada ${idx + 1}</strong></h3>
            <ul class="eventos">`;
          if (!rodada || rodada.length === 0) {
            html += `<li class="muted">â€” Sem eventos nesta rodada â€”</li>`;
          } else {
            rodada.forEach(ev => {
              const texto = escapeHtml(ev?.texto || "");
              const user = ev?.username ? `<span class="jog-label player-${(ev.order ?? 0) + 1}">${escapeHtml(ev.username)}</span> ` : "";
              html += `<li>${user}${texto}</li>`;
            });
          }
          html += `</ul></section>`;
        });

        wrap.innerHTML = html;
      }

      function aplicarPosicoesEListas(data) {
        // lista visual direita
        listaPosicoes.innerHTML = "";
        data.players.forEach(p => {
          const li = document.createElement("li");
          li.textContent = `${p.username} â€” casa ${p.position}` + (p.username === data.current_turn && data.is_active ? " (vez)" : "");
          listaPosicoes.appendChild(li);
        });

        // pinos no tabuleiro
        posicoes = data.players.map(p => p.position);
        if (window.Tabuleiro && typeof window.Tabuleiro.setPositions === "function") {
          window.Tabuleiro.setPositions(posicoes);
        }

        qtdJogElem.textContent = data.players.length;
      }

      function atualizarEstado() {
        if (finished) return;

        fetch(stateUrl)
          .then(r => r.json())
          .then(data => {
            you = data.you;
            meIndex = Math.max(0, data.players.findIndex(p => p.username === you));

            aplicarPosicoesEListas(data);
            renderLog(data.log_rounds); // <-- atualiza o log

            if (!data.is_active) {
              finished = true;
              msgElem.textContent = "Partida finalizada.";
              vezElem.textContent = "";
              btnMover.disabled = true;
              if (pollId) clearInterval(pollId);
              return;
            }

            if (data.current_turn === data.you) {
              vezElem.textContent = "Ã‰ a sua vez!";
              btnMover.disabled = false;
            } else {
              vezElem.textContent = "Vez de " + (data.current_turn || "aguardando jogadores...");
              btnMover.disabled = true;
            }
          })
          .catch(console.error);
      }

      function enviarMovimento() {
        if (finished) return;

        const posAntes = posicoes[meIndex] ?? 0;

        fetch(moveUrl, {
          method: "POST",
          headers: { "X-CSRFToken": csrfToken, "X-Requested-With": "XMLHttpRequest" },
        })
        .then(r => {
          if (!r.ok) return r.text().then(t => { throw new Error(t || "Erro ao mover"); });
          return r.json();
        })
        .then(data => {
          if (!data.ok) { resultadoElem.textContent = data.error || "Movimento invÃ¡lido."; return; }

          ultimoDadoElem.textContent = data.dice;

          // Mensagem
          let msg = `VocÃª rolou ${data.dice} e foi para a casa ${data.new_position}.`;
          if (data.pre_jump !== null && data.pre_jump !== data.new_position) {
            msg += data.new_position > data.pre_jump ? " Subiu por uma escada!" : " Desceu por uma cobra!";
          }
          resultadoElem.textContent = msg;

          // Anima no mesmo padrÃ£o do single
          if (window.Tabuleiro && typeof window.Tabuleiro.animateMove === "function") {
            window.Tabuleiro.animateMove({
              jogador: meIndex,
              de: posAntes,
              para: data.new_position,
              pre_jump: data.pre_jump
            });
          }

          if (data.finished) {
            finished = true;
            msgElem.textContent = "Partida finalizada! Vencedor: " + data.winner;
            btnMover.disabled = true;
            vezElem.textContent = "";
            if (pollId) clearInterval(pollId);
          } else {
            atualizarEstado(); // puxa novo estado e atualiza o log logo apÃ³s o lance
          }
        })
        .catch(e => { resultadoElem.textContent = "Erro: " + e.message; console.error(e); });
      }

      document.getElementById("btn-rolar-mp").addEventListener("click", enviarMovimento);
      atualizarEstado();
      pollId = setInterval(atualizarEstado, 1500);
    </script>
    {% endif %}
  </body>
</html>
{% endwith %}
