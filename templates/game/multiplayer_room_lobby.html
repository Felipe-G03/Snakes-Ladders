{% extends "game/base.html" %}
{% block title %}Sala {{ room.code }} — Lobby{% endblock %}
{% block content %}

<style>
/* ====== LAYOUT GERAL DA PÁGINA ====== */

.room-container {
  max-width: 1000px;
  margin: 40px auto;
  padding: 0 16px;
}

.room-title {
  text-align: center;
  font-size: 2.3rem;
  margin: 10px 0 6px 0;
  color: #fff;
  font-weight: 700;
  letter-spacing: 0.05em;
}

.room-subtitle {
  text-align: center;
  margin: 0 0 24px 0;
  color: #e5e7eb;
  font-size: 0.98rem;
  opacity: .9;
}

/* grid principal: configs x players/invites */
.room-grid {
  display: grid;
  grid-template-columns: minmax(0, 1.05fr) minmax(0, 1fr);
  gap: 1.8rem;
  align-items: flex-start;
}
@media (max-width: 900px) {
  .room-grid {
    grid-template-columns: 1fr;
  }
}

/* ====== CARDS ====== */

.room-card {
  background: rgba(15, 23, 42, 0.82);          /* vidro escuro */
  border-radius: 18px;
  padding: 1.8rem 2rem 1.6rem 2rem;
  box-shadow: 0 16px 40px rgba(15, 23, 42, 0.75);
  border: 1px solid rgba(148, 163, 184, 0.4);
  color: #e5e7eb;
  display: flex;
  flex-direction: column;
  gap: 0.9rem;
}

.room-card h2 {
  margin: 0 0 .4rem 0;
  font-size: 1.25rem;
}

/* card de configuração (lado esquerdo) */
.config-card {
  display: flex;
  flex-direction: column;
  gap: 1.4rem;
}

/* box do código da sala */
.config-code-box {
  background: radial-gradient(circle at top, #1e293b, #020617);
  border-radius: 14px;
  padding: 1.25rem 1.7rem 1.15rem 1.7rem;
  text-align: center;
  border: 1px solid rgba(148, 163, 184, 0.7);
}

.config-code-label {
  font-size: 0.85rem;
  color: #9ca3af;
  font-weight: 600;
  letter-spacing: .16em;
  text-transform: uppercase;
}

.config-code-main {
  font-size: 2.4rem;
  font-weight: 800;
  color: #e5e7eb;
  margin: 4px 0 2px 0;
}

.config-code-helper {
  font-size: 0.9rem;
  color: #9ca3af;
}

/* status de jogadores */
.config-status {
  display: flex;
  flex-wrap: wrap;
  gap: .8rem 1.4rem;
  font-size: 0.98rem;
  align-items: center;
}

.config-waiting {
  padding: 0.25rem 0.75rem;
  border-radius: 999px;
  background: rgba(34, 197, 94, 0.15);
  color: #bbf7d0;
  border: 1px solid rgba(34, 197, 94, 0.5);
  font-weight: 500;
}

.config-current {
  color: #e5e7eb;
}

/* ====== FORMULÁRIOS ====== */

.room-form label {
  display: block;
  margin-bottom: 0.8rem;
  font-size: 0.95rem;
  color: #e5e7eb;
}

.room-form select,
.room-form input[type="text"],
.room-form input[type="checkbox"] {
  font: inherit;
}

.room-form select,
.room-form input[type="text"] {
  width: 100%;
  border-radius: 8px;
  border: 1px solid #4b5563;
  padding: 0.55em 0.9em;
  background: rgba(15, 23, 42, 0.9);
  color: #e5e7eb;
  outline: none;
  margin-top: 0.2rem;
}

.room-form select:focus,
.room-form input[type="text"]:focus {
  border-color: #7b2ff2;
  box-shadow: 0 0 0 1px rgba(123, 47, 242, 0.65);
}

.room-form .checkbox-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin: 0.5rem 0 0.2rem 0;
}

.room-form input[type="checkbox"] {
  width: 1.1rem;
  height: 1.1rem;
}

/* botões principais desta página (reutilizam .btn + .btn-primario) */

.room-btn-full {
  width: 100%;
  justify-content: center;
}

/* ====== LISTA DE JOGADORES E CONVITES ====== */

.room-list {
  list-style: none;
  margin: 0.6rem 0 0.3rem 0;
  padding: 0;
}

.room-list li {
  padding: 0.55em 0.85em;
  border-radius: 9px;
  margin-bottom: 0.5em;
  background: rgba(15, 23, 42, 0.85);
  border: 1px solid rgba(148, 163, 184, 0.25);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: #e5e7eb;
  font-size: 0.96rem;
}

.room-list li span.badge-host {
  padding: 0.1rem 0.5rem;
  border-radius: 999px;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: .08em;
  background: rgba(251, 191, 36, 0.15);
  color: #facc15;
  border: 1px solid rgba(251, 191, 36, 0.45);
}

/* “nenhum convite/jogador” */
.muted {
  color: #a855f7;
  font-size: 0.9rem;
  opacity: .9;
}

/* ====== CONVITE DE AMIGOS ====== */

.invite-box {
  margin-top: 0.3rem;
}

.invite-input {
  width: 100%;
  padding: 0.6em 0.9em;
  border-radius: 9px;
  border: 1px solid #4b5563;
  background: rgba(15, 23, 42, 0.9);
  color: #e5e7eb;
  outline: none;
  font-size: 0.98rem;
  margin-bottom: 0.7rem;
}

.invite-input::placeholder {
  color: #9ca3af;
}

.invite-input:focus {
  border-color: #7b2ff2;
  box-shadow: 0 0 0 1px rgba(123, 47, 242, 0.65);
}

/* ====== AÇÕES FINAIS ====== */

.room-actions {
  margin-top: 1.8rem;
  display: flex;
  justify-content: center;
  gap: 0.75rem;
}
</style>

<section class="room-container">

  <div class="room-grid">
    <!-- COLUNA ESQUERDA: CÓDIGO + CONFIGURAÇÃO + INICIAR -->
    <section class="room-card config-card">
      <div class="config-code-box">
        <div class="config-code-label">Código da Sala</div>
        <div class="config-code-main">{{ room.code }}</div>
        <div class="config-code-helper">Compartilhe este código com seus amigos</div>
      </div>

      <div class="config-status">
        <span class="config-waiting">Aguardando jogadores</span>
        <span class="config-current" id="room-player-count">
        {{ players|length }}/4 jogadores
        </span>
      </div>

      <form
        method="post"
        action="{% url 'game:multiplayer_config' code=room.code %}"
        class="room-form"
      >
        {% csrf_token %}
        <label>
          Tamanho do tabuleiro
          <select name="board_size">
            <option value="10x10" {% if room.board_size == "10x10" %}selected{% endif %}>10 × 10</option>
            <option value="5x5" {% if room.board_size == "5x5" %}selected{% endif %}>5 × 5</option>
          </select>
        </label>

        <label class="checkbox-row">
          <input type="checkbox" name="is_public" {% if room.is_public %}checked{% endif %}>
          <span>Sala pública (qualquer pessoa poderá entrar)</span>
        </label>

        {% if room.host_id == request.user.id %}
          <button class="btn btn-primario room-btn-full" type="submit">
            Salvar configurações
          </button>
        {% else %}
          <p class="muted">Apenas o host pode alterar as configurações.</p>
        {% endif %}
      </form>

      {% if room.host_id == request.user.id %}
        <form
          method="post"
          action="{% url 'game:multiplayer_start' code=room.code %}"
          style="margin-top: 0.7rem;"
        >
          {% csrf_token %}
          <button class="btn btn-primario room-btn-full" type="submit">
            Iniciar jogo
          </button>
        </form>
      {% endif %}
    </section>

    <!-- COLUNA DIREITA: JOGADORES + CONVITES -->
    <section class="room-card">
      <div>
        <h2>Jogadores na sala</h2>
        <ul id="room-players" class="room-list">
          {% for p in players %}
            <li>
              {% if p.user_id == room.host_id %}
                <span class="badge-host">Host</span>
              {% endif %}
              <span>{{ p.user.username }}</span>
            </li>
          {% empty %}
            <li class="muted">Nenhum jogador conectado ainda.</li>
          {% endfor %}
        </ul>
      </div>

      <div>
        <h2>Convidar amigo</h2>
        {% if room.host_id == request.user.id %}
          <div class="invite-box">
            <form method="post" action="{% url 'game:multiplayer_invite' code=room.code %}">
              {% csrf_token %}
              <input
                name="username"
                class="invite-input"
                placeholder="Nome de usuário do amigo"
                required
              >
              <button class="btn btn-primario room-btn-full" type="submit">
                Enviar convite
              </button>
            </form>
          </div>
        {% else %}
          <p class="muted">Apenas o host pode enviar convites.</p>
        {% endif %}
      </div>

      <div>
        <h3 style="margin-top: 1rem;">Convites enviados</h3>
        <ul class="room-list">
          {% for inv in invites %}
            <li>
              <span>{{ inv.invitee.username }}</span>
              <span style="margin-left:auto; font-size:0.82rem; text-transform:uppercase; letter-spacing:.08em; opacity:.8;">
                {{ inv.status }}
              </span>
            </li>
          {% empty %}
            <li class="muted">Nenhum convite enviado.</li>
          {% endfor %}
        </ul>
      </div>
    </section>
  </div>

  <div class="room-actions">
    <a class="btn" href="{% url 'game:multiplayer_lobby' %}">
      Voltar ao Lobby
    </a>
  </div>
</section>

<script>
  // Atualiza players e detecta início
const infoUrl = "{% url 'game:api_room_info' code=room.code %}";
let poll = setInterval(async () => {
  try {
    const r = await fetch(infoUrl);
    const data = await r.json();
    if (data.status === "active") {
      clearInterval(poll);
      location.reload();
      return;
    }

    const ul = document.getElementById("room-players");
    const countSpan = document.getElementById("room-player-count");

    if (!ul) return;
    ul.innerHTML = "";

    // atualiza texto da contagem mesmo se não tiver players
    const qtd = (data.players && data.players.length) ? data.players.length : 0;
    if (countSpan) {
      countSpan.textContent = `${qtd}/4 jogadores`;
    }

    if (!data.players || !data.players.length) {
      const li = document.createElement("li");
      li.className = "muted";
      li.textContent = "Nenhum jogador conectado ainda.";
      ul.appendChild(li);
      return;
    }

    data.players.forEach(p => {
      const li = document.createElement("li");
      li.className = "room-player-item";

      if (p.is_host) {
        const badge = document.createElement("span");
        badge.className = "badge-host";
        badge.textContent = "Host";
        li.appendChild(badge);
      }

      const nameSpan = document.createElement("span");
      nameSpan.textContent = p.username;
      li.appendChild(nameSpan);
      ul.appendChild(li);
    });
  } catch(e) {
    console.error(e);
  }
}, 1500);
</script>
{% endblock %}
